class Point{constructor(e,t){this.x=e,this.y=t}}class Rectangle{constructor(e){this.setElm(e)}setElm(e){this.$elm=e,this.height=e.height(),this.width=e.width(),this.y=e.offset().top,this.x=e.offset().left}contains(e){if(e instanceof Point){let t=e;return this.y<=t.y&&this.y+this.height>=t.y&&this.x<=t.x&&this.x+this.width>=t.x}}center(){return new Point(this.x+this.width/2,this.y+this.height/2)}getX(){return this.$elm.offset().left}getWidth(){return this.$elm.width()}moveTo(e){if(e instanceof Rectangle&&(e=e.$elm),e instanceof jQuery){const t=e.offset().left,n=e.offset().top;this.moveToPoint(new Point(t,n))}e instanceof Point&&this.moveToPoint(e)}moveToPoint(e){this.moving=!0,this.$elm.animate({top:e.y,left:e.x},200,function(){this.moving=!1})}sideOf(e){if(e instanceof Point)return this.center().x>e.x?this.LEFT:this.RIGHT}id(){return this.$elm[0].id}setDragged(){this.dragged=!0,this.$elm.addClass("dragged").removeClass("ready").css({"z-index":1e3})}disappear(){this.$elm.fadeOut(200,()=>this.$elm.remove())}empty(){return!this.internalRectangle}add(e){return this.internalRectangle=e}has(e){return e===this.internalRectangle}frees(){this.internalRectangle=void 0}}Rectangle.prototype.LEFT=-1,Rectangle.prototype.RIGHT=1;const audio=new Audio("assets/snapsound.mp3");class BlocksView{constructor(){this.idCounter=0,this.pieces=[],this.placeholders=[],this.clickedIds=[],this.$programmingView=$("#programming-view"),this.$placeholdersArea=$("#placeholders-area"),this.highlightPiece=new Rectangle($("#highlight")),this.isTimeToSnap=!0,this.createInitialPieces(),this.createInitialPlaceholders(),this.configureScrollListener()}createInitialPieces(){$(".available.block.piece").on("mousedown",e=>{this.cloneAndCreatePiece($(e.target))}).trigger("mousedown")}cloneAndCreatePiece(e){let t=this.clone(e);return this.createPiece(t)}createInitialPlaceholders(){$(".block.placeholder").each((e,t)=>{this.placeholders.push(new Rectangle($(t)))})}configureScrollListener(){$(window).on("scroll",()=>{$(".ready.piece").hide(),clearTimeout($.data(this,"scrollTimer")),$.data(this,"scrollTimer",setTimeout(()=>{$(".ready.piece").show(),this.adjustPiecesToPlaceholders(),this.adjustAvailableReadyPieces(),this.updatePlaceholderElements();const e=this.getOccupedPlaceholders()[this.highlightPiece.index];this.highlightPiece.moveTo(e)},450))})}clone(e){let t=e.clone();t.removeClass("available").addClass("ready").css({position:"absolute",top:e.offset().top,left:e.offset().left}).appendTo(this.$programmingView).draggable({start:e=>this.handleDragStart(e),stop:e=>this.handleDragStop(e),drag:e=>this.handleDrag(e),scroll:!1}).mouseup(e=>this.notifyClickedPiece(e));let n=++this.idCounter;return t.id=n,t[0].id=n,t}getOrCreatePiece(e){let t=e.target,n=t.id;return this.findPieceById(n)||this.createPiece($(t))}createPiece(e){let t=new Rectangle(e);return this.pieces.push(t),t}findPieceById(e){let t=this.pieces.filter(t=>t instanceof Rectangle&&t.id()==e);if(t.length)return t[0]}handleDragStart(e){this.adjustAvailableReadyPieces();let t=this.getOrCreatePiece(e);this.isTimeToSnap=!1,setTimeout(()=>{this.isTimeToSnap=!0},300),this.freesPlaceholder(t),this.organizePostionZ(t),t.dragged||(this.clone(t.$elm),t.setDragged())}handleDrag(e){let t=this.getOrCreatePiece(e);t.setElm($(e.target)),this.moveSnapedPieceIfIsTimeToSnap(t),this.markThatThePieceEnteredPlaceholdersArea(t),this.changePieceColorIfOutside(t)}handleDragStop(e){let t=this.getOrCreatePiece(e);this.removeIfOutside(t)||this.snapToPlaceholder(t),this.movePiecesToLeft(),this.removeRemainingPlaceholders(),this.adjustAreaWidth(),this.adjustPiecesToPlaceholders(),this.addRightPlaceholder(),this.notifyChangedPieces()}markThatThePieceEnteredPlaceholdersArea(e){this.getPlaceholdersRectangle().contains(e.center())&&(e.enteredPlaceholdersArea=!0)}changePieceColorIfOutside(e){e.enteredPlaceholdersArea&&this.addOrRemoveOutsideBorder(e)}addOrRemoveOutsideBorder(e){const t=!this.getPlaceholdersRectangle().contains(e.center()),n=e.$elm.find("img")[0],i=$(n);let o=i.attr("src");const s=o.indexOf("_exit")!==-1;if(t&&!s){const e=o.split(".");o=e[0]+"_exit.svg",i.attr("src",o)}else!t&&s&&(o=o.replace("_exit",""),i.attr("src",o))}getPlaceholdersRectangle(){return new Rectangle($("#placeholders-area"))}adjustAvailableReadyPieces(){$(".ready.piece").each((e,t)=>{const n=$(t).attr("data-command"),i=$(".available."+n);$(t).css("left",i.offset().left)})}adjustPiecesToPlaceholders(){this.placeholders.forEach(e=>{e.empty()||e.internalRectangle.moveTo(e)})}organizePostionZ(e){let t=e.id(),n=this.clickedIds.indexOf(t);n!=-1&&this.clickedIds.splice(n,1),this.clickedIds.push(t),$(".piece.dragged").each((e,t)=>{let n=this.clickedIds.indexOf(t.id)+10;$(t).css("z-index",n)})}movePiecesToLeft(){let e=0;for(;e<this.placeholders.length;){let t=this.placeholders[e];if(t.empty()){let n,i=e;for(;i<this.placeholders.length&&!n;)this.placeholders[i].empty()||(n=this.placeholders[i]),i++;n&&(this.snap(t,n.internalRectangle),n.frees())}e++}}adjustAreaWidth(){const e=$(window).width(),t=this.getOccupedPlaceholders().length,n=50*t+50+50+50;this.$placeholdersArea.css("width",n<e?e:n)}getOccupedPlaceholders(){return this.placeholders.filter(e=>!e.empty())}getFreePlaceholders(){return this.placeholders.filter(e=>e.empty())}getSnappedPieces(){return this.getOccupedPlaceholders().map(e=>e.internalRectangle)}freesPlaceholder(e){let t=this.placeholders.filter(t=>t.has(e))[0];t&&t.frees()}removeIfOutside(e){if(!this.getPlaceholdersRectangle().contains(e.center())&&e.enteredPlaceholdersArea)return e.disappear(),this.pieces.splice(this.pieces.indexOf(e),1),!0}snapToPlaceholder(e){this.placeholders.forEach(t=>{if(t.empty()&&t.contains(e.center()))return void this.snap(t,e)})}snap(e,t){e.add(t),t.moveTo(e),audio.play()}addRightPlaceholder(){const e=this.getOccupedPlaceholders();this.placeholders.length===e.length&&(this.createPlaceholder(Rectangle.prototype.RIGHT),this.adjustPiecesToPlaceholders())}removeRemainingPlaceholders(){let e=this.getOccupedPlaceholders().length;for(;this.placeholders.length>e+3;)this.placeholders.pop(),$(".placeholder").last().remove(),this.adjustPiecesToPlaceholders();this.updatePlaceholderElements()}createPlaceholder(e){let t=$($(".placeholder")[0]),n=t.clone(),i=new Rectangle(n);return e===Rectangle.prototype.LEFT?(this.$placeholdersArea.prepend(n),this.placeholders.unshift(i)):(this.$placeholdersArea.append(n),this.placeholders.push(i)),this.updatePlaceholderElements(),i}updatePlaceholderElements(){$(".block.placeholder").each((e,t)=>{this.placeholders[e].setElm($(t))})}getOrCreatePlaceholder(e,t){if(!this.placeholders[t+e]){let t=this.createPlaceholder(e);return this.adjustPiecesToPlaceholders(),t}return this.placeholders[t+e]}moveSnapedPieceIfIsTimeToSnap(e){this.isTimeToSnap&&this.moveSnapedPiece(e)}moveSnapedPiece(e){this.placeholders.forEach((t,n)=>{this.ifHasPieceThenMove(t,n,e)})}ifHasPieceThenMove(e,t,n){if(!e.empty()&&e.contains(n.center())){let i=this.calcMoveSide(e,t,n);this.movePlaceholderPiece(e,i)}}calcMoveSide(e,t,n){if(0==t)return Rectangle.prototype.RIGHT;if(t==this.placeholders.length-1)return Rectangle.prototype.LEFT;let i=e.sideOf(n.center());if(i===Rectangle.prototype.LEFT){if(this.placeholders[t-1].empty())return Rectangle.prototype.LEFT;if(this.placeholders[t+1].empty())return Rectangle.prototype.RIGHT}if(i===Rectangle.prototype.RIGHT){if(this.placeholders[t+1].empty())return Rectangle.prototype.RIGHT;if(this.placeholders[t-1].empty())return Rectangle.prototype.LEFT}return Rectangle.prototype.RIGHT}movePlaceholderPiece(e,t){let n=this.placeholders.indexOf(e),i=this.getOrCreatePlaceholder(t,n);i.empty()||this.movePlaceholderPiece(i,t),this.snap(i,e.internalRectangle),e.frees()}setCommands(e){const t=this.getSnappedPieces();this.syncronized(t,e.slice(0,-1))?this.addPieceFrom(e[e.length-1]):(this.removeSnappedPieces(),this.removeRemainingPlaceholders(),this.hideHighlight(),e.forEach(e=>this.addPieceFrom(e))),this.adjustAreaWidth(),this.adjustPiecesToPlaceholders(),this.getSnappedPieces().forEach(e=>e.setDragged())}syncronized(e,t){if(e.length!=t.length)return!1;for(let n=0;n<t.length;n++){const i=t[n];if(!e[n].$elm.hasClass(i))return!1}return!0}addPieceFrom(e){const t=this.cloneAndCreatePiece($(".available.piece."+e)),n=this.getFreePlaceholders()[0];t.moveTo(n),this.snap(n,t),this.movePiecesToLeft(),this.addRightPlaceholder()}removeSnappedPieces(){this.getOccupedPlaceholders().forEach(e=>{e.internalRectangle.$elm.remove(),e.frees()})}highlightSnapped(){this.getSnappedPieces().forEach(e=>{e.$elm.css("z-index",10)})}hideHighlight(){this.highlightPiece.$elm.fadeOut(400)}disableDragging(){$(".ui-draggable").draggable("disable")}enableDragging(){$(".ui-draggable-handle").draggable("enable")}highlight({command:command,index:index}){const e=this.getOccupedPlaceholders()[index];if(e){const t=e.internalRectangle;this.highlightPiece.moveTo(t.$elm),this.highlightPiece.$elm.fadeIn(100),this.scrollToShow(t),this.highlightPiece.index=index}}removePiece(e){e.disappear(),e=void 0}on(e,t){this[e]||(this[e]=[]),this[e].push(t)}notify(e,t){this[e].forEach(e=>e.call(this,t))}notifyChangedPieces(){const e=this.getSnappedPieces();this.notify("changed",e)}notifyClickedPiece(e){const t=e.currentTarget.id,n=this.getOccupedPlaceholders().find(e=>e.internalRectangle.id()==t),i=this.placeholders.indexOf(n);this.notify("click",i)}pointToIndex(e){const t=this.getOccupedPlaceholders()[e];if(t){const e=t.getX(),n=$("#pointer"),i=new Rectangle(n),o=new Point(e,t.y+60);i.moveTo(o),n.fadeIn(400),this.scrollToShow(t)}}scrollToShow(e){const t=$("html").scrollLeft(),n=e.getX()+e.getWidth(),i=$(window).width();if(n>i+t){const e=n-i;this.scrollTo(e+50)}else t>e.getX()&&this.scrollTo(e.getX()-50)}scrollTo(e){$("html").animate({scrollLeft:e},400)}hidePointer(){$("#pointer").fadeOut(400)}}$(function(){const e={a:"advance",b:"back",l:"left",r:"right"},t={bluetooth:bluetooth,blocks:new BlocksView,sounds:{start:new Audio("assets/startsound.wav"),stop:new Audio("assets/stopsound.wav"),error:new Audio("assets/error.flac"),next:new Audio("assets/next.wav")},executedIndex:-1};$("#magnifying-button").on("click",()=>{t.startSearch()}),$("#rope-connection").on("click",()=>{$("#rope-connection").hasClass("disconnected")&&t.startSearch()}),$("#debug-button").on("click",()=>{t.toggleDebug()}),$("#go-block").on("click",()=>{t.bluetooth.setCharacteristic("s")}),t.bluetooth.on("connected",()=>{t.showProgrammingView(),t.setConnected(!0)}),t.bluetooth.on("connection-failed",()=>{t.showMagnifying(!1),t.setConnected(!1)}),t.bluetooth.on("characteristic-changed",e=>{t.handleChangeOn(e)}),t.blocks.on("changed",e=>{t.setPiecesCharacteristic(e)}),t.blocks.on("click",e=>{t.debug&&t.started&&(t.executedIndex+1!=e?t.sounds.error.play():(t.sounds.next.play(),t.bluetooth.setCharacteristic("n")))}),$(window).on("scroll",()=>{t.adjustShadowWidth()}),t.showMagnifying=(e=>{e?$("#magnifying").show("fast"):$("#magnifying").hide("slow")}),t.showProgrammingView=(()=>{$("#connecting-view").hide(400,()=>$("#programming-view").show())}),t.showConnectionView=(()=>{$("#connecting-view").is(":visible")||$("#programming-view").hide(400,()=>$("#connecting-view").show())}),t.showDebugging=(()=>{$("#debug-button").toggleClass("active")}),t.showShadow=(()=>{t.sounds.start.play(),$("#shadow").length||$('<div id="shadow"></div>').css({width:"100%",height:"100vh",opacity:"0.5",background:"gray",position:"fixed","z-index":"3",display:"none"}).prependTo($("#programming-view")),$("#shadow").fadeIn(400,"linear"),t.blocks.highlightSnapped()}),t.showStopped=(()=>{t.sounds.stop.play(),t.hideShadow(),t.blocks.removeSnappedPieces(),t.blocks.removeRemainingPlaceholders(),t.blocks.adjustAreaWidth(),t.blocks.hidePointer()}),t.hideShadow=(()=>{t.blocks.hideHighlight(),$("#shadow").fadeOut(1e3,"linear")}),t.showAdded=(e=>{t.blocks.setCommands(e)}),t.showStartedAction=(({command:command,index:index})=>{t.blocks.highlight({command:command,index:index})}),t.pointPieceToExecute=(()=>{t.debug?t.blocks.pointToIndex(t.executedIndex+1):t.blocks.hidePointer()}),t.adjustShadowWidth=(()=>{$("#shadow").length&&$("#shadow").width("100%")}),t.startSearch=(()=>{t.bluetooth.search(),t.showMagnifying(!0),t.showConnectionView()}),t.registerServiceWorker=(()=>{"serviceWorker"in navigator&&navigator.serviceWorker.register("service-worker.js").then(e=>{console.log("Service Worker Registered")})}),t.setConnected=(e=>{e?$("#rope-connection").addClass("connected").removeClass("disconnected"):$("#rope-connection").addClass("disconnected").removeClass("connected")}),t.handleChangeOn=(e=>{const n=e.split(":"),i=n[0];switch(console.log(e),i){case"started":return t.blocks.disableDragging(),t.showShadow(),t.started=!0,t.pointPieceToExecute();case"stopped":return t.blocks.enableDragging(),t.executedIndex=-1,t.started=!1,t.showStopped();case"updated_commands":let o=n[1];return o=t.translate(o),t.showAdded(o);case"started_action":let s=n[1],c=n[2];return t.executedIndex=new Number(c),t.showStartedAction({command:s,index:c}),t.pointPieceToExecute();case"finished_action":return t.blocks.hideHighlight(),void t.pointPieceToExecute()}}),t.translate=(t=>{const n=[];for(let i=0;i<t.length;i++){const o=t.charAt(i);n.push(e[o])}return n}),t.toggleDebug=(()=>{t.debug=!t.debug,t.bluetooth.setCharacteristic("d:"+(t.debug?1:0)),t.showDebugging()}),t.setPiecesCharacteristic=(e=>{let n="";e.forEach(e=>{n+=e.$elm.attr("data-command").charAt(0)}),t.bluetooth.setCharacteristic(n)})});const bluetooth={eventHandlers:{},characteristic:""};bluetooth.search=(()=>{bluetooth.notify("connected");rope.onChange(e=>{bluetooth.notify("characteristic-changed",e)}),rope.startCommunication()}),bluetooth.setCharacteristic=(e=>{rope.write(e)}),bluetooth.on=((e,t)=>{bluetooth.getEventHandlers(e).push(t)}),bluetooth.getEventHandlers=(e=>{return bluetooth.eventHandlers[e]||(bluetooth.eventHandlers[e]=[]),bluetooth.eventHandlers[e]}),bluetooth.notify=((e,t)=>{bluetooth.getEventHandlers(e).forEach(e=>e.call(this,t))});const rope={actions:[],actionIndex:-1};rope.buttons={START:"i",ADVANCE:"a",GO_BACK:"b",TURN_LEFT:"l",TURN_RIGHT:"r"},rope.states={STOPPED:{handleClick:e=>{if(e===rope.buttons.START)rope.executeActions();else{rope.actions.push(e);let t="";rope.actions.forEach(e=>t+=e),rope.onChangeHandler.call(this,"updated_commands:"+t)}},handleWrite:e=>{"s"===e?rope.executeActions():e.indexOf("d:")!=-1?rope.debugging=1==e.split(":")[1]:rope.actions=e.split("")}},EXECUTING:{handleClick:e=>{},handleWrite:e=>{"s"===e?(rope.actions=[],rope.stop()):e.indexOf("d:")!=-1?rope.debugging=1==e.split(":")[1]:e.indexOf("n")!=-1&&(rope.mustExecuteNextAction=!0)}}},rope.onChange=(e=>{rope.onChangeHandler=e}),rope.startCommunication=(()=>{rope.state=rope.states.STOPPED;const e="aralalararabbalararra";rope.actions=e.split(""),rope.onChangeHandler.call(this,"updated_commands:"+e)}),rope.nothingToExecute=(()=>{return 0===rope.actions.length||rope.state===rope.states.STOPPED}),rope.executeNextAction=(()=>{if(rope.nothingToExecute())return rope.stop();const e=rope.actions.shift();rope.actionIndex++,rope.onChangeHandler.call(this,`started_action:${e}:${rope.actionIndex}`),rope.previousAction=e}),setInterval(()=>{rope.state==rope.states.EXECUTING&&(rope.previousAction&&(rope.onChangeHandler.call(this,`finished_action:${rope.previousAction}:${rope.actionIndex-1}`),rope.previousAction=void 0),rope.debugging?rope.debugging&&rope.mustExecuteNextAction?(rope.executeNextAction(),rope.mustExecuteNextAction=!1):rope.nothingToExecute()&&rope.stop():rope.executeNextAction())},2e3),rope.executeActions=(()=>{rope.actions.length&&(rope.onChangeHandler.call(this,"started"),rope.state=rope.states.EXECUTING,rope.actionIndex=-1)}),rope.stop=(()=>{rope.state=rope.states.STOPPED,rope.onChangeHandler.call(this,"stopped"),rope.actionIndex=-1}),rope.write=(e=>{rope.state.handleWrite(e)}),rope.state=rope.states.STOPPED;
